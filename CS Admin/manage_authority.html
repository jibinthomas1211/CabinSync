<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CabinSync</title>
    <style>
        @font-face {
            font-family: 'longreach';
            src: url('assets/font/longreach.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'patuaone';
            src: url('assets/font/patuaone.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'roboto';
            src: url('assets/font/roboto.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0px;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: white;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: filter 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #1E293B;
            border-bottom: 2px solid white;
            color: white;
            font-family: 'longreach';
            font-size: large;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 40px;
            margin-right: 10px;
        }

        .profile-icon img {
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .search-add {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 4px;
            align-items: center;
            margin: 10px auto;
            width: 90%;
            padding-left: 5px;
            padding-right: 5px;
        }

        h2 {
            margin: 0;
            font-weight: bold;
            font-family: 'longreach';
        }

        .search {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            padding: 8px;
            border-radius: 10px;
            border: 2px solid black;
        }

        .search input {
            border: none;
            background: none;
            outline: none;
            margin-left: 8px;
            font-family: 'patuaone';
        }

        .add-button {
            background-color: #1E293B;
            color: white;
            padding: 8px 46px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'patuaone';
            border: 2px solid #1E293B;
        }

        .add-button:hover {
            background: #324362;
        }

        .table-container {
            position: relative;
            flex-grow: 1;
            overflow-y: auto;
            width: 90%;
            margin: auto;
            border: 2px solid black;
            border-radius: 10px 10px 0 0;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            background-color: #1E293B;
            color: white;
            z-index: 2;
            font-family: 'patuaone';
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            font-family: 'roboto';
        }

        th {
            background-color: #1E293B;
            color: white;
            font-family: 'patuaone';
            z-index: 2;
            top: 0;
        }

        .right {
            margin-left: 10px;
        }

        .left {
            margin-right: 10px;
        }

        .footer {
            text-align: center;
            font-size: 12px;
            padding: 5px;
            font-family: 'patuaone';
            font-weight: bold;
            margin: 10px 0;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            pointer-events: all;
        }

        .popup {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .popup h2 {
            text-align: center;
        }

        .popup label {
            display: block;
            font-family: 'roboto';
        }

        .popup-form {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        .popup-form div {
            display: flex;
            flex-direction: column;
            width: 45%;
        }

        .popup input,
        select {
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            font-family: 'roboto';
        }

        .popup-buttons {
            width: 100%;
            display: flex;
            justify-content: space-between;
            justify-content: center;
            gap: 20px;
        }

        .popup-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'patuaone';
        }

        .save-button {
            background: #1E293B;
            color: white;
        }

        .cancel-button {
            background: #888;
            color: white;
        }

        .action-buttons img:hover {
            cursor: pointer;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="logo">
            <img src="assets/img/logo.svg" alt="CabinSync Logo">
            <span style="font-size: 36px; letter-spacing: 2px;">CABINSYNC</span>
        </div>
        <div class="profile-icon">
            <img src="assets/img/profile.png" alt="User Profile">
        </div>
    </div>
    <div class="search-add">
        <h2 style='flex-grow: 1;'>MANAGE AUTHORITY PERSONNELS</h2>
        <div class="search">
            <input type="text" placeholder="Search" id="searchInput">
        </div>
        <button class="add-button" onclick="openPopup()">Add</button>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <h2>Authority Personnel</h2>
            <div class="popup-form">
                <div>
                    <label for="popupId">ID</label>
                    <input type="text" id="popupId" required>
                </div>
                <div>
                    <label for="popupName">Name</label>
                    <input type="text" id="popupName" required>
                </div>
                <div>
                    <label for="popupEmail">Email</label>
                    <input type="email" id="popupEmail" required>
                </div>
                <div>
                    <label for="popupDept">Department</label>
                    <select id="popupDept" required>
                        <option value="" disabled selected>Select Department</option>
                        <option value="Administration">Administration</option>
                        <option value="Computer Science UG">Computer Science UG</option>
                        <option value="Computer Science PG">Computer Science PG</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="Commerce">Commerce</option>
                        <option value="Humanities">Humanities</option>
                    </select>
                </div>
                <div>
                    <label for="popupDesignation">Designation</label>
                    <input type="text" id="popupDesignation" required>
                </div>
                <div>
                    <label for="popupLocation">Location</label>
                    <input type="text" id="popupLocation" required>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="save-button" onclick="saveData()">Save</button>
                <button class="cancel-button" onclick="closePopup()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="padding-left: 30px;">Name</th>
                    <th>Department</th>
                    <th>Designation</th>
                    <th>Location</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="authorityTableBody">

            </tbody>
        </table>
    </div>
    <div class="footer">Copyright © CabinSync | All Rights Reserved</div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuT-EuUhQ-u9tGBgku4FmiYKTBwlg4LMk",
            authDomain: "cabinsync-97406.firebaseapp.com",
            databaseURL: "https://cabinsync-97406-default-rtdb.firebaseio.com",
            projectId: "cabinsync-97406",
            storageBucket: "cabinsync-97406.appspot.com",
            messagingSenderId: "11620501071",
            appId: "1:11620501071:web:64040e5be54202930fcc3a",
            measurementId: "G-YY3CFVG8RV"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const authorityRef = ref(database, "Authority");

        let editKey = null; // track if we’re editing

        const popupOverlay = document.getElementById('popupOverlay');
        const addButton = document.querySelector('.add-button');
        const cancelButton = document.querySelector('.cancel-button');
        const saveButton = document.querySelector('.save-button');

        // Open popup 
        function openPopup() {
            const randomId = "Auth" + Math.floor(100000 + Math.random() * 900000); 

            const idField = document.getElementById("popupId");
            if (idField) {
                idField.value = randomId; 
            }
            
            document.getElementById("popupOverlay").style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Popup close
        function closePopup() {
            popupOverlay.style.display = 'none';
            document.body.style.overflow = 'auto';
            editKey = null;
            document.getElementById("popupId").value = "";
            document.getElementById("popupName").value = "";
            document.getElementById("popupEmail").value = "";
            document.getElementById("popupDept").value = "";
            document.getElementById("popupDesignation").value = "";
            document.getElementById("popupLocation").value = "";
        }

        // Save to Firebase
        function saveData() {
            const id = document.getElementById("popupId").value;
            const name = document.getElementById("popupName").value;
            const email = document.getElementById("popupEmail").value;
            const department = document.getElementById("popupDept").value;
            const designation = document.getElementById("popupDesignation").value;
            const location = document.getElementById("popupLocation").value;
            const status = "Available";

            const data = { id, name, email, department, designation, location, status };

            if (!id || !name || !email || !department || !designation || !location) {
                alert("Please fill all fields!");
                return;
            }

            try {
                if (editKey) {
                    // Update mode
                    const updateRef = ref(database, `Authority/${editKey}`);
                    update(updateRef, data)
                        .then(() => {
                            alert("Data updated successfully!");
                            editKey = null;
                            loadAuthorityData();
                            closePopup();
                        })
                        .catch(err => alert("Update failed: " + err.message));
                } else {
                    // Add mode
                    const personnelRef = push(ref(database, "Authority"));
                    set(personnelRef, data)
                        .then(() => {
                            alert("Data saved successfully!");
                            loadAuthorityData();
                            closePopup();
                        })
                        .catch(error => alert("Error saving data: " + error.message));
                }
            }
            catch (err) {
                alert(err.message);
            }
        }

        // Event listeners
        if (addButton) addButton.addEventListener('click', openPopup);
        if (cancelButton) cancelButton.addEventListener('click', closePopup);
        if (saveButton) saveButton.addEventListener('click', saveData);

        // Load data and optionally filter
        function loadAuthorityData(searchTerm = "") {
            const tableBody = document.getElementById("authorityTableBody");
            const authorityRef = ref(database, "Authority");

            onValue(authorityRef, (snapshot) => {
                tableBody.innerHTML = "";

                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();

                    const term = searchTerm.toLowerCase();
                    const matches =
                        data.name.toLowerCase().includes(term) ||
                        data.id.toLowerCase().includes(term);

                    if (matches || searchTerm === "") {
                        const row = document.createElement("tr");
                        row.classList.add("fade-in");
                        row.innerHTML = `
                    <td style="padding-left: 30px;">${data.name}<br><span style="color: #7B7B7B; font-size: 14px;">${data.id}</span></td>
                    <td>${data.department}</td>
                    <td>${data.designation}</td>
                    <td>${data.location}</td>
                    <td class="action-buttons">
                        <img class="left edit-btn" src="assets/img/edit.svg" alt="Edit" data-key="${key}">
                        <img class="right delete-btn" src="assets/img/delete.svg" alt="Delete" data-key="${key}">
                    </td>
                `;
                        tableBody.appendChild(row);
                    }
                });

                // Attach click event to all edit buttons
                document.querySelectorAll(".edit-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const key = btn.getAttribute("data-key");
                        loadEntryToEdit(key);
                    });
                });

                // Attach click event to all delete buttons
                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const key = btn.getAttribute("data-key");
                        deleteEntry(key);
                    });
                });
            });
        }

        // Listen to search input changes
        document.getElementById("searchInput").addEventListener("input", (e) => {
            const searchTerm = e.target.value;
            loadAuthorityData(searchTerm);
        });

        function loadEntryToEdit(key) {
            const itemRef = ref(database, `Authority/${key}`);
            onValue(itemRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById("popupId").value = data.id;
                    document.getElementById("popupName").value = data.name;
                    document.getElementById("popupEmail").value = data.email;
                    document.getElementById("popupDept").value = data.department;
                    document.getElementById("popupDesignation").value = data.designation;
                    document.getElementById("popupLocation").value = data.location;

                    editKey = key; // Save the key for update
                    openPopup();   // Show the popup
                }
            }, { onlyOnce: true });
        }

        function deleteEntry(key) {
            const confirmDelete = confirm("Are you sure you want to delete this entry?");
            if (!confirmDelete) return;

            const entryRef = ref(database, `Authority/${key}`);
            set(entryRef, null)
                .then(() => {
                    alert("Entry deleted successfully!");
                    loadAuthorityData(); // Refresh table
                })
                .catch((error) => {
                    alert("Error deleting entry: " + error.message);
                });
        }

        // Load all data on page load
        window.addEventListener("DOMContentLoaded", () => {
            loadAuthorityData(); // loads all data initially
        });
    </script>
</body>

</html>